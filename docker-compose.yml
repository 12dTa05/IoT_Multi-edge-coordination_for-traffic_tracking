version: '3.8'

services:
  traffic-monitor:
    build:
      context: .
      dockerfile: Dockerfile
    image: traffic-monitor:latest
    container_name: traffic-monitor
    
    # Use host network for display
    network_mode: host
    
    # NVIDIA GPU runtime
    runtime: nvidia
    
    # Environment variables
    environment:
      - DISPLAY=${DISPLAY:-:0}
      - VIDEO_FILE=${VIDEO_FILE:-/app/test_videos/test.mp4}
      - CUDA_VISIBLE_DEVICES=0
      - LD_PRELOAD=/usr/lib/aarch64-linux-gnu/libgomp.so.1
      - QT_X11_NO_MITSHM=1
      - XAUTHORITY=/tmp/.docker.xauth
    
    # Volume mounts
    volumes:
      # Configuration files
      - ./configs:/app/configs:ro
      
      # Model files (YOLO engines)
      - ./DeepStream-YoLo:/app/DeepStream-YoLo:ro
      
      # Logs and outputs (persistent)
      - ./logs:/app/logs
      - ./output:/app/output
      
      # Video files for testing
      - ./test_videos:/app/test_videos:ro
      
      # X11 socket for display
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - /tmp/.docker.xauth:/tmp/.docker.xauth:rw
    
    # Devices
    devices:
      - /dev/video0:/dev/video0  # USB camera (if needed)
    
    # Restart policy
    restart: unless-stopped
    
    # Resource limits (optional)
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu]
    
    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    
    # Command - process MP4 file and display on screen
    command: python3 run_file.py ${VIDEO_FILE}

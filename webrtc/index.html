<!-- <!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>DeepStream WebRTC</title>
  <style>body{margin:0;display:grid;place-items:center;height:100vh;background:#111} video{width:90vw;max-width:1280px;background:#000}</style>
</head>
<body>
  <video id="v" autoplay playsinline controls></video>
  <script>
    const room = new URLSearchParams(location.search).get("room") || "demo";
    const pc = new RTCPeerConnection({
      iceServers: [{urls: "stun:stun.l.google.com:19302"}]
    });
    const video = document.getElementById("v");
    pc.ontrack = (ev) => { video.srcObject = ev.streams[0]; };
    pc.onicecandidate = (ev) => {
      if (ev.candidate) {
        ws.send(JSON.stringify({type: "ice", candidate: ev.candidate}));
      }
    };

    const ws = new WebSocket(`ws://${location.hostname}:8080/ws?room=${room}`);
    ws.onmessage = async (ev) => {
      const msg = JSON.parse(ev.data);
      if (msg.type === "offer") {
        await pc.setRemoteDescription({type: "offer", sdp: msg.sdp});
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        ws.send(JSON.stringify({type: "answer", sdp: answer.sdp}));
      } else if (msg.type === "ice") {
        try{ await pc.addIceCandidate(msg.candidate); }catch(e){ console.warn(e); }
      }
    };
  </script>
</body>
</html> -->

<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Giám sát giao thông </title>
  <style>
    :root{
      --bg:#0a0b0f; --panel:#11141a; --panel-2:#0f1217; --card:#151a22;
      --fg:#e6e9ef; --muted:#9aa4b2; --accent:#1c70ff; --ok:#31c48d; --warn:#f59e0b;
      --ring:#2b3340; --inset:#0b0e13; --chip:#1e2632; --border:#1f2631;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,var(--bg),#07090c);color:var(--fg);font:14px/1.5 system-ui,Segoe UI,Roboto,Arial,"Helvetica Neue",Helvetica,sans-serif}
    a{color:inherit}

    /* Page layout */
    .page{display:flex;flex-direction:column;min-height:100vh}
    .toolbar{background:var(--panel);border-bottom:1px solid var(--border);padding:10px 16px;display:flex;align-items:center;gap:10px}
    .toolbar h1{font-size:16px;margin:0;font-weight:600;letter-spacing:.2px}
    .grow{flex:1}
    .btn{appearance:none;border:1px solid var(--border);background:var(--chip);color:var(--fg);padding:8px 12px;border-radius:11px;cursor:pointer;font-weight:600;transition:.15s;box-shadow:0 1px 0 #000 inset}
    .btn:hover{filter:brightness(1.08)}
    .btn-primary{background:linear-gradient(180deg,#1c70ff,#1056d6);border-color:#134fbf;box-shadow:0 0 0 1px rgba(19,79,191,.2) inset,0 8px 24px rgba(16,86,214,.25)}
    .btn-danger{background:linear-gradient(180deg,#de3b2f,#c63025);border-color:#a2251c}
    .btn-ghost{background:transparent}

    /* Main area below toolbar */
    .app{flex:1;display:grid;grid-template-columns:1fr 360px;gap:16px;padding:16px;min-height:0}
    .left{display:flex;flex-direction:column;min-height:0}
    .grid{display:grid;gap:12px;grid-template-columns:repeat(2,1fr);grid-template-rows:repeat(2,1fr);min-height:0;flex:1}
    .cell{min-height:0;min-width:0}
    .card{position:relative;background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:hidden;height:100%}
    .stage{position:absolute;inset:0;display:grid;place-items:center;background:#000}
    .card video{width:100%;height:100%;object-fit:contain;display:block;background:#000}

    /* Overlay info + actions */
    .overlay{position:absolute;left:8px;right:8px;bottom:8px;display:flex;align-items:center;gap:8px;justify-content:space-between;pointer-events:none}
    .badge{pointer-events:auto;background:rgba(30,38,50,.75);backdrop-filter:blur(4px);border:1px solid var(--border);border-radius:999px;padding:4px 8px;font-size:12px;display:flex;gap:6px;align-items:center}
    .dot{width:8px;height:8px;border-radius:99px;background:#666;box-shadow:0 0 0 1px var(--ring)}
    .dot.ok{background:var(--ok)} .dot.warn{background:var(--warn)}
    .actions{pointer-events:auto;display:flex;gap:6px}
    .actions .btn{padding:6px 10px;border-radius:10px}

    /* Pager (grid) */
    .pager{display:flex;gap:8px;align-items:center}
    .page-info{font-size:12px;color:var(--muted)}

    /* Sidebar (violations) */
    .right{background:var(--panel);border:1px solid var(--border);border-radius:12px;display:flex;flex-direction:column;min-height:0}
    .right header{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px}
    .right header h2{font-size:15px;margin:0}
    .feed{padding:10px;display:flex;flex-direction:column;gap:10px;overflow:auto}
    .item{display:flex;gap:10px;background:var(--panel-2);border:1px solid var(--border);border-radius:12px;padding:8px}
    .item img{width:84px;height:56px;background:#000;border-radius:8px;object-fit:cover}
    .i-body{display:flex;flex-direction:column;gap:2px;min-width:0}
    .i-title{font-weight:700}
    .i-sub{font-size:12px;color:var(--muted)}
    .i-row{display:flex;gap:8px;align-items:center}
    .pill{font-size:11px;border:1px solid var(--border);background:var(--chip);border-radius:999px;padding:2px 6px}

    /* Feed pager */
    .feed-controls{display:flex;align-items:center;gap:8px;margin-left:auto}
    .muted{color:var(--muted);font-size:12px}

    /* Modal */
    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.45);backdrop-filter:blur(2px)}
    .modal.show{display:grid}
    .dialog{width:min(480px,92vw);background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px}
    .dialog h3{margin:4px 0 12px 0}
    .field{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
    label{font-size:12px;color:var(--muted)}
    input[type=text]{background:var(--inset);border:1px solid var(--border);color:var(--fg);border-radius:10px;padding:10px 12px;outline:none}
    .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:6px}

    @media (max-width: 1100px){
      .app{grid-template-columns:1fr} .right{order:-1;height:40vh}
      .grid{grid-template-columns:repeat(2,1fr);grid-template-rows:repeat(2,1fr)}
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="toolbar">
      <div class="grow"></div>
      <div class="pager">
        <button id="prevPage" class="btn btn-ghost" title="Trang trước">‹ Trước</button>
        <span id="pageInfo" class="page-info">Trang 1/1</span>
        <button id="nextPage" class="btn btn-ghost" title="Trang sau">Sau ›</button>
      </div>
      <button id="addBtn" class="btn btn-primary">+ Thêm nguồn</button>
    </div>

    <div class="app">
      <div class="left">
        <div id="grid" class="grid"></div>
      </div>

      <aside class="right">
        <header>
          <h2>Cảnh báo vi phạm</h2>

          <!-- Nút clear + phân trang cho cột vi phạm -->
          <div class="feed-controls">
            <button id="feedPrev" class="btn btn-ghost" title="Trang trước">‹</button>
            <span id="feedInfo" class="muted">1/1</span>
            <button id="feedNext" class="btn btn-ghost" title="Trang sau">›</button>
            <button id="clearFeed" class="btn btn-danger" title="Xóa danh sách">Xóa</button>
          </div>
        </header>
        <div id="feed" class="feed" aria-live="polite"></div>
      </aside>
    </div>
  </div>

  <!-- Add Source Modal -->
  <div id="modal" class="modal" role="dialog" aria-modal="true">
    <div class="dialog">
      <h3>Thêm nguồn mới</h3>
      <div class="field">
        <label>Tên phòng (room)</label>
        <input id="roomInput" type="text" placeholder="vd: Luồng 1 / cam_gate_01" />
      </div>
      <div class="field">
        <label>Máy chủ signaling (mặc định: host hiện tại)</label>
        <input id="serverInput" type="text" placeholder="vd: 192.168.1.50" />
      </div>
      <div class="actions">
        <button id="cancelAdd" class="btn">Hủy</button>
        <button id="saveAdd" class="btn btn-primary">Thêm</button>
      </div>
    </div>
  </div>

  <!-- Lightbox for violation thumbnails -->
  <div id="lightbox" class="modal" onclick="Lightbox.hide()">
    <img id="lbImg" alt="preview" style="max-width:92vw;max-height:92vh;border-radius:12px;border:1px solid var(--border);"/>
  </div>

  <script>
  const $ = (sel, el=document) => el.querySelector(sel);
  const grid = $('#grid');

  /* ===== Lightbox ===== */
  const Lightbox = {
    show(b64){ const lb=$('#lightbox'); $('#lbImg').src = `data:image/jpeg;base64,${b64}`; lb.classList.add('show'); },
    hide(){ $('#lightbox').classList.remove('show'); }
  }
  window.Lightbox = Lightbox;

  /* ===== Pagination (grid nguồn) ===== */
  const pageInfo = $('#pageInfo');
  const prevBtn = $('#prevPage');
  const nextBtn = $('#nextPage');
  const PAGE_SIZE = 4;
  let SOURCES = [];
  let currentPage = 1;
  function totalPages(){ return Math.max(1, Math.ceil(SOURCES.length / PAGE_SIZE)); }
  function renderGrid(){
    const tp = totalPages();
    if(currentPage > tp) currentPage = tp;
    if(currentPage < 1) currentPage = 1;
    grid.innerHTML = '';
    const start = (currentPage - 1) * PAGE_SIZE;
    const end = Math.min(start + PAGE_SIZE, SOURCES.length);
    for(let i=start; i<end; i++){
      const cell = document.createElement('div');
      cell.className = 'cell';
      cell.appendChild(SOURCES[i].card);
      grid.appendChild(cell);
    }
    for(let k=end; k<start+PAGE_SIZE; k++){
      const empty = document.createElement('div'); empty.className='cell';
      grid.appendChild(empty);
    }
    pageInfo.textContent = `Trang ${currentPage}/${tp}`;
    prevBtn.disabled = currentPage <= 1;
    nextBtn.disabled = currentPage >= tp;
  }
  prevBtn.onclick = ()=>{ if(currentPage>1){ currentPage--; renderGrid(); } };
  nextBtn.onclick = ()=>{ if(currentPage<totalPages()){ currentPage++; renderGrid(); } };

  /* ===== Sources (WebRTC + WS) ===== */
  let SRC_ID = 1;
  class Source {
    constructor(room, server){
      this.id = SRC_ID++;
      this.room = room || 'Luồng ' + this.id;
      this.server = server || location.hostname;
      this.ws = null; this.pc = null; this.video = null; this.card = null; this.dot = null; this._closing=false;
      this._buildCard();
      this._connect();
    }
    _buildCard(){
      const card = document.createElement('div'); card.className='card';
      const stage = document.createElement('div'); stage.className='stage'; card.appendChild(stage);
      const v = document.createElement('video'); v.autoplay=true; v.playsInline=true; v.controls=true; stage.appendChild(v);

      // Overlay
      const ov = document.createElement('div'); ov.className='overlay'; card.appendChild(ov);
      const badge = document.createElement('div'); badge.className='badge'; ov.appendChild(badge);
      const dot = document.createElement('span'); dot.className='dot'; badge.appendChild(dot);
      const name = document.createElement('span'); name.textContent=this.room; badge.appendChild(name);
      const actions = document.createElement('div'); actions.className='actions'; ov.appendChild(actions);
      const btnRe = document.createElement('button'); btnRe.className='btn'; btnRe.textContent='Kết nối lại'; btnRe.onclick=()=>this.reconnect(); actions.appendChild(btnRe);
      const btnRm = document.createElement('button'); btnRm.className='btn'; btnRm.textContent='Xóa'; btnRm.onclick=()=>removeSource(this); actions.appendChild(btnRm);

      this.card=card; this.video=v; this.dot=dot;
    }

    _setStatus(kind){
      this.dot.classList.remove('ok','warn');
      if(kind==='ok'){ this.dot.classList.add('ok'); }
      else if(kind==='warn'){ this.dot.classList.add('warn'); }
    }

    _connect(){
      const wsURL = `ws://${this.server}:8080/ws?room=${encodeURIComponent(this.room)}&role=sub`;
      this.ws = new WebSocket(wsURL);
      this.ws.addEventListener('open', ()=>{ this._setStatus('warn'); });
      this.ws.addEventListener('close', ()=>{ if(!this._closing){ this._setStatus(); setTimeout(()=>this.reconnect(), 1200);} });
      this.ws.addEventListener('error', ()=>{ this._setStatus(); });
      this.ws.addEventListener('message', (ev)=>this._onWS(ev));

      this.pc = new RTCPeerConnection({ iceServers:[{urls:'stun:stun.l.google.com:19302'}] });
      this.pc.ontrack = (ev)=>{ this.video.srcObject = ev.streams[0]; this._setStatus('ok'); };
      this.pc.onicecandidate = (ev)=>{ if(ev.candidate){ this.ws?.send(JSON.stringify({type:'ice', candidate: ev.candidate})); } };
    }

    async _onWS(ev){
      let msg; try{ msg = JSON.parse(ev.data); }catch{ return; }
      if(msg.type === 'offer'){
        try{
          await this.pc.setRemoteDescription({type:'offer', sdp: msg.sdp});
          const ans = await this.pc.createAnswer();
          await this.pc.setLocalDescription(ans);
          this.ws?.send(JSON.stringify({type:'answer', sdp: ans.sdp}));
        }catch(e){ console.warn('SDP error', e); }
        return;
      }
      if(msg.type === 'ice'){
        try{ await this.pc.addIceCandidate(msg.candidate); }catch(e){ console.warn('ICE error', e); }
        return;
      }
      if(msg.type === 'overspeed'){
        // Ghi nhận vi phạm -> mảng để phân trang
        addViolation({...msg, room:this.room});
        return;
      }
    }

    reconnect(){ this.destroy(true); this._connect(); }
    destroy(keepCard=false){
      this._closing=true;
      try{ this.ws?.close(); }catch{}
      try{ this.pc?.getSenders().forEach(s=>{ try{s.track?.stop()}catch{} }); this.pc?.close(); }catch{}
      if(!keepCard){ try{ this.card.remove(); }catch{} }
      this._closing=false;
    }
  }

  function addSource(room, server){
    const src = new Source(room, server);
    SOURCES.push(src);
    renderGrid();
  }
  function removeSource(src){
    const idx = SOURCES.indexOf(src);
    if(idx !== -1) SOURCES.splice(idx, 1);
    src.destroy(false);
    renderGrid();
  }

  /* ===== Violation feed + pagination ===== */
  const feed = $('#feed');
  const feedPrev = $('#feedPrev');
  const feedNext = $('#feedNext');
  const feedInfo = $('#feedInfo');
  const FEED_PAGE_SIZE = 8;

  // Lưu tất cả vi phạm ở đây để phân trang
  const VIOLATIONS = []; // newest ở đầu (index 0)

  let feedPage = 1;
  function feedTotalPages(){
    return Math.max(1, Math.ceil(VIOLATIONS.length / FEED_PAGE_SIZE));
  }
  function renderFeed(){
    const tp = feedTotalPages();
    if(feedPage > tp) feedPage = tp;
    if(feedPage < 1) feedPage = 1;

    feed.innerHTML = '';
    const start = (feedPage - 1) * FEED_PAGE_SIZE;
    const end = Math.min(start + FEED_PAGE_SIZE, VIOLATIONS.length);

    // Hiển thị theo thứ tự thời gian giảm dần trong mỗi trang
    for(let i = start; i < end; i++){
      const v = VIOLATIONS[i];
      const el = document.createElement('div'); el.className='item';
      const img = document.createElement('img'); img.alt = 'snapshot'; img.src = v.image_b64 ? `data:image/jpeg;base64,${v.image_b64}` : '';
      img.onclick = ()=> v.image_b64 && Lightbox.show(v.image_b64);
      el.appendChild(img);

      const body = document.createElement('div'); body.className='i-body'; el.appendChild(body);
      const title = document.createElement('div'); title.className='i-title'; title.textContent = `${Math.round(v.speed_kmh)} km/h`;
      body.appendChild(title);
      const tsText = v.ts || new Date().toLocaleString();
      const sub = document.createElement('div'); sub.className='i-sub'; sub.textContent = `${tsText} • #${v.track_id}`;
      body.appendChild(sub);

      const row = document.createElement('div'); row.className='i-row'; body.appendChild(row);
      const p1 = document.createElement('span'); p1.className='pill'; p1.textContent = v.room || 'room'; row.appendChild(p1);
      if(v.filename){ const p2=document.createElement('span'); p2.className='pill'; p2.textContent=v.filename; row.appendChild(p2); }

      feed.appendChild(el);
    }

    feedInfo.textContent = `${feedPage}/${tp}`;
    feedPrev.disabled = feedPage <= 1;
    feedNext.disabled = feedPage >= tp;
  }

  function addViolation(v){
    // Chèn mới nhất lên đầu mảng
    const ts = v.ts || new Date().toLocaleString();
    VIOLATIONS.unshift({...v, ts});
    // Khi có vi phạm mới: luôn quay về trang 1 để hiển thị 5 cái mới nhất
    feedPage = 1;
    renderFeed();

    // Giới hạn tổng tối đa để không phình DOM/memory (tùy chỉnh)
    const MAX_KEEP = 500;
    if(VIOLATIONS.length > MAX_KEEP){
      VIOLATIONS.length = MAX_KEEP;
    }
  }

  $('#clearFeed').onclick = ()=>{
    VIOLATIONS.length = 0; // xóa dữ liệu
    feedPage = 1;
    renderFeed();
  };
  feedPrev.onclick = ()=>{ if(feedPage>1){ feedPage--; renderFeed(); } };
  feedNext.onclick = ()=>{ if(feedPage<feedTotalPages()){ feedPage++; renderFeed(); } };

  /* ===== Modal thêm nguồn ===== */
  const modal = $('#modal');
  const addBtn = $('#addBtn');
  const roomInput = $('#roomInput'); const serverInput = $('#serverInput');
  $('#cancelAdd').onclick = ()=> modal.classList.remove('show');
  $('#saveAdd').onclick = ()=> {
    const room = roomInput.value.trim();
    if(!room){ roomInput.focus(); return; }
    const server = serverInput.value.trim() || location.hostname;
    addSource(room, server);
    modal.classList.remove('show');
    roomInput.value=''; serverInput.value='';
  };
  addBtn.onclick = ()=> modal.classList.add('show');

  /* ===== Auto-add từ URL (?room=a,b,c&server=IP) ===== */
  (function(){
    const sp = new URLSearchParams(location.search);
    const rooms = (sp.get('room')||'').split(',').map(s=>s.trim()).filter(Boolean);
    const server = sp.get('server')||undefined;
    rooms.forEach(r=> addSource(r, server));
    // render feed lần đầu
    renderFeed();
  })();
  </script>
</body>
</html>
